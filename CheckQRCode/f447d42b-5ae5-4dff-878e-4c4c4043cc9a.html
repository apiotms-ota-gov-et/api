
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">

    <style>

        .container {
           margin-left: 0px;
        }

        .aisLabel {
            font-size: 20px;
        }

        .certificateLabel {
            font-size: 12px;
            margin-top: 6px;
        }

        .headerContainer {
            display: flex;
            flex-direction: row;
            margin-top: 8px;
            max-width: 300px;
            font-size: 10px;
        }

        .fieldLabel {
            margin-left: 20px;
        }

        .valueLabel {
            margin-left: 80px;
        }

        .innerContainer {
            display: flex;
            flex-direction: row,
        }

        .itemContainer {
            display: flex;
            flex-direction: column;
            font-size: 10px;
        }

        .valueContainer {
            display: flex;
            flex-direction: column;
            margin-left: 5px;
            font-size: 10px;
        }

        .footerContainer {
            display: flex;
            flex-direction: row;
            margin-top: 8px;
            font-size: 10px;
        }

    </style>
    <script>
        var urlSearchParams = new URLSearchParams(window.location.search);
        var params = Object.fromEntries(urlSearchParams.entries());

        const getGeneratedDate = (date = new Date()) => {
            const pad = (n) => String(n).padStart(2, "0");

            return (
                date.getFullYear() + "-" +
                pad(date.getMonth() + 1) + "-" +
                pad(date.getDate()) + " " +
                pad(date.getHours()) + ":" +
                pad(date.getMinutes()) + ":" +
                pad(date.getSeconds())
            );
        }

        var enc = new TextEncoder();
        var dec = new TextDecoder();

        function base64ToBuffer(base64) {
            return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
        }

        async function deriveKey(password, salt) {
            const keyMaterial = await crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                "PBKDF2",
                false,
                ["deriveKey"]
            );

            return crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: enc.encode(salt),
                    iterations: 100000,
                    hash: "SHA-256",
                },
                keyMaterial,
                { name: "AES-GCM", length: 256 },
                false,
                ["encrypt", "decrypt"]
            );
        }

        async function decrypt(payload, password) {
            const salt = base64ToBuffer(payload.salt);
            const iv = base64ToBuffer(payload.iv);
            const data = base64ToBuffer(payload.data);

            const key = await deriveKey(password, salt);

            const decrypted = await crypto.subtle.decrypt(
                { name: "AES-GCM", iv },
                key,
                data
            );

            return dec.decode(decrypted);
        }

        document.addEventListener("DOMContentLoaded", async () => {
            document.getElementById("generatedDate").innerText = getGeneratedDate();
            const decryptedData = JSON.parse(await decrypt(JSON.parse(document.getElementById("hashValue").innerText), params.ID));
            document.getElementById("serialNo").innerText = decryptedData.serialNo;
            document.getElementById("plateNo").innerText = decryptedData.plateNo;
            document.getElementById("chassisNo").innerText = decryptedData.chassisNo;
            document.getElementById("boloPlate").innerText = decryptedData.boloPlate;
            document.getElementById("boloYear").innerText = decryptedData.boloYear;
            document.getElementById("serviceZone").innerText = decryptedData.zone;
            document.getElementById("issueDate").innerText = decryptedData.issueDate;
        });

    </script>
</head>

<body>
    <div class="container">
        <label class="aisLabel"><b>AIS CERTIFICATE</b></label>
        <br />
        <label class="certificateLabel"><b>ANNUAL INSPECTION CERTIFICATE</b></label>

        <div class="headerContainer">
            <label class="fieldLabel"><b>Field</b></label>
            <label class="valueLabel"><b>Value</b></label>
        </div>

        <div class="innerContainer">
            <div class="itemContainer">
                <label>Serial Number</label>
                <label>Plate Number</label>
                <label>Chassis Number</label>
                <label>Bolo Plate</label>
                <label>Bolo Year</label>
                <label>Service Zone</label>
                <label>Issue Date</label>
            </div>

            <div class="valueContainer">
                <label id="serialNo"></label>
                <label id="plateNo"></label>
                <label id="chassisNo"></label>
                <label id="boloPlate"></label>
                <label id="boloYear"></label>
                <label id="serviceZone"></label>
                <label id="issueDate"></label>
            </div>
        </div>

        <div class="footerContainer">
            <label>Generated on:</label>
            <label id="generatedDate" style="margin-left: 5px;"></label>
        </div>

        <div id="hashValue" style="display: none">{"salt":"BGZfBBx1HGIJeHgBn4VXVg==","iv":"SMt6boI580Nz37hb","data":"gqomdjEo5phOffoF7iHfO44tMoVdNWsid19PQYcJSUtgcgIRyXKYbFXxdSZmSMYMH99WCfzVFLLoGLdjDxei58G+8actKD8rfJU0d6OJ+eDtSTNoHjCQf99soHXrOzVdMwo5KrAzzLOSheaE/O4uZMqoC1m9Mnqskpu5jnsiDcvNbzDrnTrc6Uiv/AyDpHTXP8gRMNoBRMqhEjbwEztuJO39nS8V40p0SWeelTV2DdrS"}</div>
    </div>
</body>

</html>
